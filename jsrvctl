#!/usr/bin/env bash

instance_name="$2"
oper="$1"
source /etc/jsrvctl/jsrvctl.profile

check_user() {
    if [ -z "${ADMINGROUPS}" ]; then
        echo "ADMINGROUPS environment variable is not set"
        exit 2
    else
        ADMINGROUPS=${ADMINGROUPS// /\\|}
        result=$(groups |grep -w ${ADMINGROUPS} |grep -v grep |wc -l)
        if [[ ${result} -eq  0 ]]; then
            echo "Your username '($(whoami))' must belong to '${ADMINGROUPS}' group to use this script. Please contact your system administrator."
            exit 3
        fi
    fi
    return 0
}

start_instance() {
    instance_name=$1
    if [ -f "/etc/jsrvctl/${instance_name}.profile" ]; then
        . /etc/jsrvctl/${instance_name}.profile
    else
        echo "Error: '/etc/jsrvctl/${instance_name}.profile' file not found."
        exit 4
    fi
    if [ -z "${JAVA_OPTS}" ]; then
        echo "Error: Java environment variables is not properly set in '/etc/jsrvctl/${instance_name}.profile' file for this operation."
        exit 5
    fi
    if [ -z "${APPUSER}" ]; then
        echo "Error: APPUSER variable is not set in '/etc/jsrvctl/${instance_name}.profile' file for this operation."
        exit 6
    fi
    if [ $(ps -ef |grep java |grep -v grep |grep -v ant |grep "${PS_REGEX}" |wc -l) -ne 0 ]; then
        echo "'${instance_name}' is already started."
        exit 7
    fi
    echo "'${instance_name}' is being started..."
    sudo -u ${APPUSER} -E instance_name="${instance_name}" bash -c '. /etc/jsrvctl/${instance_name}.profile; nohup "${STARTUP_CMD[@]}" >> /tmp/${instance_name}.log 2>> /tmp/${instance_name}.log &'
    sleep 1
    echo "'${instance_name}' was started."
    return 0
}

status_instance() {
    instance_name=$1
    if [ -f "/etc/jsrvctl/${instance_name}.profile" ]; then
        . /etc/jsrvctl/${instance_name}.profile
    else
        echo "Error: '/etc/jsrvctl/${instance_name}.profile' file not found."
        exit 4
    fi
    if [ $(ps -ef |grep java |grep -v grep |grep -v ant |grep "${PS_REGEX}" |wc -l) -gt 0 ]; then
        echo "'${instance_name}' is running. Process count is $(ps -ef |grep java |grep -v grep |grep -v ant |grep "${PS_REGEX}" |wc -l)"
    else
        echo "'${instance_name}' is not running."
    fi
    return 0
}

start() {
    if [[ "${instance_name}" == "all" ]]; then
        for instance_name in $(cat /etc/jsrvctl/instances) 
        do
            start_instance ${instance_name}
        done
    else
        start_instance ${instance_name} 
    fi
    return 0
}

status() {
    if [[ "${instance_name}" == "all" ]]; then
        for instance_name in $(cat /etc/jsrvctl/instances |grep -v '^[[:blank:]]*#' |grep -v '^[[:blank:]]*$')
        do
            status_instance ${instance_name}
        done
    else
        status_instance ${instance_name}
    fi
    return 0
}

show_help() {
	echo "Usage: $0 {start|stop|status} {instance_name|all}"
        echo "Help: $0 --help"
	exit 1 
}


check_user
case "${oper}" in
    start)
        start
        ;;
    stop)
        echo "stop"
        ;;
    status)
        status
        ;;
    --help)
        show_help
        ;;
    *)
        echo "Unknown operation '${oper}'"  
        show_help
        ;;
esac
